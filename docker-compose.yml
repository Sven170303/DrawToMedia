# =============================================================================
# Draw to Digital Media - Docker Compose
# =============================================================================
# Eine Datei für alle Deployment-Szenarien:
#
# 1. LOCALHOST (npm run dev empfohlen, aber Docker möglich)
#    → Nutzt .env.local → Supabase Development Branch
#
# 2. COOLIFY DEVELOPMENT
#    → ENV in Coolify UI konfigurieren → Supabase Development Branch
#    → Git Branch: development
#
# 3. COOLIFY PRODUCTION
#    → ENV in Coolify UI konfigurieren → Supabase Production Branch
#    → Git Branch: main
#
# Coolify: Einfach Git-Repo verbinden, ENV-Variablen in UI setzen, deployen.
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:?Supabase URL is required}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:?Supabase Anon Key is required}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:?Stripe Publishable Key is required}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:?App URL is required}
        NEXT_PUBLIC_GA_MEASUREMENT_ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:?}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:?}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:?}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:?}
      - NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}
    ports:
      - "3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
