# =============================================================================
# Draw to Digital Media - Docker Compose
# =============================================================================
# Eine Datei für alle Deployment-Szenarien:
#
# 1. LOCALHOST mit Docker Desktop
#    → docker-compose --env-file .env.local up -d
#    → Erreichbar unter http://localhost:3002
#    → Nutzt Supabase Development Branch
#
# 2. COOLIFY DEVELOPMENT (Git Branch: development)
#    → ENV in Coolify UI konfigurieren
#    → Coolify verwaltet Ports über Reverse Proxy (Caddy/Traefik)
#    → Nutzt Supabase Development Branch
#
# 3. COOLIFY PRODUCTION (Git Branch: main)
#    → ENV in Coolify UI konfigurieren
#    → Coolify verwaltet Ports über Reverse Proxy (Caddy/Traefik)
#    → Nutzt Supabase Production Branch
#
# COOLIFY SETUP:
#   - "Ports Exposes" in Coolify UI auf 3000 setzen
#   - Alle NEXT_PUBLIC_* Variablen in Coolify Environment konfigurieren
#   - Build Pack: Docker Compose
# =============================================================================

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:?Supabase URL is required}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:?Supabase Anon Key is required}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:?Stripe Publishable Key is required}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:?App URL is required}
        NEXT_PUBLIC_GA_MEASUREMENT_ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:?}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:?}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:?}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:?}
      - NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}
    ports:
      # Lokal: 3002:3000 (HOST_PORT nicht gesetzt → Default 3002)
      # Coolify: Ignoriert diese Zeile und nutzt Reverse Proxy
      - "${HOST_PORT:-3002}:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
